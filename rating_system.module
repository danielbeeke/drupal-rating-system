<?php
/**
* @file
* The main file for the rating system module.
*
* Here we include all the other files.
*/

include_once('rating_system.crud.inc');
include_once('rating_system.score.inc');
include_once('rating_system.display.inc');
include_once('rating_system.percentage.inc');

/**
 * Access callback.
 */
function rating_formula_access($permission) {
  return user_access($permission);
}

/**
 * Implements hook_permission().
 */
function rating_system_permission() {
  return array(
    'administer rating formulas' =>  array(
      'title' => t('Administer rating formulas'),
      'description' => t('Administer rating formulas'),
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function rating_system_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'rating_system') . '/includes/views',
  );
}

/**
 * Implements hook_entity_update().
 */
function rating_system_entity_update($entity, $type) {
  if ($type != 'rating_formula') {
    $entity_info = entity_get_info($type);

    $rating_formulas = rating_formula_load_multiple_by_entity_type_and_bundle($type);
    if ($rating_formulas) {
      foreach ($rating_formulas as $rating_formula) {
        if ($rating_formula->flush == 2) {
          rating_system_flush_cached_entity_formula_score($entity->{$entity_info['entity keys']['id']}, $rating_formula);
        }
      }
    }
  }
}
